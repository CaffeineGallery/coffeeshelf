#!/bin/bash
# üóÉÔ∏è CoffeeShelf - Terminal Shelf Dashboard for Coffee Shell

# Plugin metadata
SHELF_DIR="$HOME/.caffeine/plugins/coffeeshelf"
CONFIG_FILE="$SHELF_DIR/config.conf"
MODULES_DIR="$SHELF_DIR/modules"

# Create a config if doesn't exist
if [[ ! -f "$SHELF_DIR/config" ]]; then
    touch "$SHELF_DIR/config"
fi

# Load config
set -o allexport
source "$CONFIG_FILE"
set +o allexport


# Load modules
load_modules() {
  for module in "${MODULES[@]}"; do
    MODULE_PATH="$MODULES_DIR/$module.sh"
    if [[ -f "$MODULE_PATH" ]]; then
      source "$MODULE_PATH"
    else
      echo "‚ö†Ô∏è Module $module not found."
    fi
  done
}

# TUI Display
show_shelf() {
  clear
  echo -e "\e[1;32müóÉÔ∏è CoffeeShelf - Your Coffee Dashboard\e[0m"
  echo "--------------------------------------"
  echo

  # Dynamically call widget functions
  for widget in "${WIDGETS[@]}"; do
    if declare -f "$widget" > /dev/null; then
      "$widget"
    else
      echo "‚ö†Ô∏è  Widget function '$widget' not found."
    fi
    echo
  done

  echo "--------------------------------------"
  echo
  read -rp "" "$user_cmd"
  if [[ -n "$user_cmd" ]]; then
    if [[ "$user_cmd" == "exit" ]]; then
        exit 0
    fi
    if [[ "$user_cmd" == "refresh" ]]; then
        shelf
        exit 0
    fi
    echo -e "\n(Press Enter to return to shelf...)"
    read
  fi
}


# Run the shelf
main() {
  mkdir -p "$SHELF_DIR/logs"
  load_modules
  while true; do
    show_shelf
  done
}

main
